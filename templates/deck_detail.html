{% extends "base.html" %}

{% block content %}
    <div class="container">
        <h1>Deck {{ deck.name }}!</h1>
        <h6>by <a href="/user/{{ deck.creator.id }}">{{ deck.creator.username }}</a></h6>
        {% if current_user.is_authenticated %}
            {% if current_user.id == deck.creator_id or current_user.username == 'admin' %}
                <a href="/edit_deck/{{ deck.id }}" class="btn btn-outline-secondary">Редактировать</a>
            {% endif %}
            {% if deck in current_user.decks.all %}
                <a href="/review/{{ deck.id }}" class="btn btn-outline-secondary">Повторить</a>
                <a href="/test/{{ deck.id }}" class="btn btn-outline-secondary">Тест</a>
            {% else %}
                <a href="/add_deck/{{ deck.id }}" class="btn btn-outline-secondary">Добавить</a>
            {% endif %}
        {% else %}
            <a href="/test/{{ deck.id }}" class="btn btn-outline-secondary">Тест</a>
        {% endif %}
    </div>

    {% if deck.words %}
        {% if current_user.is_authenticated %}
            <div class="container">
                <div id="chart-container">
                    <canvas id="myChart"></canvas>
                </div>
                <div id="info-container"></div>
            </div>
            {% include "includes/word_table.html" with deck=deck%}
        {% else %}
            <div class="table-container">
                <div class="table-row heading">
                    <div class="row-item">Слово</div>
                    <div class="row-item">Произношение</div>
                    <div class="row-item">Перевод</div>
                </div>
                {% for card in deck.cards %}
                    <div class="card-row">
                        <div class="table-row parent">
                            <div class="row-item">
                                <div class="chinese">{{ card.chinese }}</div>
                            </div>
                            <div class="row-item">{{ card.transcription }}</div>
                            <div class="row-item">{{ card.translation }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% else %}
        <p>No cards yet.</p>
    {% endif %}

    <div class="modal fade" id="modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stroke Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block sort %}
<script>
    const percentHeader = document.querySelector('.heading .percent-header');
    const dateHeader = document.querySelector('.heading .date-header');
    percentHeader.addEventListener('click', sortByPercent);
    dateHeader.addEventListener('click', sortByDate);

    function resetStyles() {
        const percentHeader = document.querySelector('.percent-header');
        const dateHeader = document.querySelector('.date-header');

        percentHeader.classList.remove('ascending', 'descending');
        dateHeader.classList.remove('ascending', 'descending');
    }

    let isPercentSortAscending = true;

    function sortByPercent() {
        const tableContainer = document.querySelector('.table-container');
        const heading = tableContainer.querySelector('.heading');
        const cardRows = Array.from(tableContainer.querySelectorAll('.card-row'));

        cardRows.sort((a, b) => {
            const aParentRow = a.querySelector('.parent');
            const bParentRow = b.querySelector('.parent');

            const aPercent = parseFloat(aParentRow.querySelector('.percent').textContent.replace('%', ''));
            const bPercent = parseFloat(bParentRow.querySelector('.percent').textContent.replace('%', ''));

            return isPercentSortAscending ? aPercent - bPercent : bPercent - aPercent;
        });

        const fragment = document.createDocumentFragment();

        fragment.appendChild(heading);

        cardRows.forEach(cardRow => {
            fragment.appendChild(cardRow);
        });

        tableContainer.textContent = ''; // Clear existing content
        tableContainer.appendChild(fragment);

        resetStyles();
        isPercentSortAscending = !isPercentSortAscending;
        const percentHeader = document.querySelector('.heading .percent-header');
        percentHeader.classList.remove('ascending', 'descending');
        percentHeader.classList.add(isPercentSortAscending ? 'ascending' : 'descending');
    }

    let isDateSortAscending = true;

    function sortByDate() {
        const tableContainer = document.querySelector('.table-container');
        const heading = tableContainer.querySelector('.heading');
        const cardRows = Array.from(tableContainer.querySelectorAll('.card-row'));

        cardRows.sort((a, b) => {
            const aParentRow = a.querySelector('.parent');
            const bParentRow = b.querySelector('.parent');

            const aDate = new Date(aParentRow.querySelector('.date').textContent);
            const bDate = new Date(bParentRow.querySelector('.date').textContent);

            return isDateSortAscending ? aDate - bDate : bDate - aDate;
        });

        const fragment = document.createDocumentFragment();

        fragment.appendChild(heading);

        cardRows.forEach(cardRow => {
            fragment.appendChild(cardRow);
        });

        tableContainer.textContent = ''; // Clear existing content
        tableContainer.appendChild(fragment);

        resetStyles();
        isDateSortAscending = !isDateSortAscending;
        const dateHeader = document.querySelector('.heading .date-header');
        dateHeader.classList.remove('ascending', 'descending');
        dateHeader.classList.add(isDateSortAscending ? 'ascending' : 'descending');
    }
</script>
{% endblock %}
