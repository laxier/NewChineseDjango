{% extends "base.html" %}
{% load static %}

{% block title %}{{ chinese_word.simplified }} Details{% endblock %}

{% block content %}
    <h1>{{ chinese_word.simplified }}</h1>
    <p>Pinyin: {{ chinese_word.pinyin }}</p>
    <p>Meaning: {{ chinese_word.meaning }}</p>
    <p>HSK: {{ chinese_word.hsk_level }}</p>

    <h2>Stroke Order</h2>
    <div id="stroke-order-container"></div>
    {% include 'wordpages/includes/sentences_list.html' %}
    {% include 'wordpages/includes/related_words_list.html' %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/hanzi-writer/dist/hanzi-writer.min.js"></script>
<script>
    function renderFanningStrokes(target, strokes) {
        const isDarkMode = localStorage.getItem('theme') === 'dark';
        const strokeColor = isDarkMode ? '#ffffff' : '#333333';
        const gridColor = isDarkMode ? '#333333' : '#d6dbe1';

        var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.style.width = '75px';
        svg.style.height = '75px';
        svg.style.border = '1px solid #EEE';
        svg.style.marginRight = '3px';
        target.appendChild(svg);

        var gridBackground = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        gridBackground.setAttribute('width', '75');
        gridBackground.setAttribute('height', '75');

        const lines = [
            {x1: 0, y1: 0, x2: 75, y2: 75},
            {x1: 75, y1: 0, x2: 0, y2: 75},
            {x1: 37.5, y1: 0, x2: 37.5, y2: 75},
            {x1: 0, y1: 37.5, x2: 75, y2: 37.5}
        ];

        lines.forEach(line => {
            var gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            gridLine.setAttribute('x1', line.x1);
            gridLine.setAttribute('y1', line.y1);
            gridLine.setAttribute('x2', line.x2);
            gridLine.setAttribute('y2', line.y2);
            gridLine.setAttribute('stroke', gridColor);
            gridBackground.appendChild(gridLine);
        });

        svg.appendChild(gridBackground);

        var group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        var transformData = HanziWriter.getScalingTransform(75, 75);
        group.setAttributeNS(null, 'transform', transformData.transform);
        svg.appendChild(group);

        strokes.forEach(function (strokePath) {
            var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttributeNS(null, 'd', strokePath);
            path.style.fill = strokeColor;
            group.appendChild(path);
        });
    }

    const chineseCharacters = "{{ chinese_word.simplified }}";
    const container = document.getElementById('stroke-order-container');

    function loadAndRenderCharacterStrokes(characters) {
        characters.split('').forEach((char) => {
            HanziWriter.loadCharacterData(char).then(function (charData) {
                const target = document.createElement('div');
                container.appendChild(target);

                for (var i = 0; i < charData.strokes.length; i++) {
                    var strokesPortion = charData.strokes.slice(0, i + 1);
                    renderFanningStrokes(target, strokesPortion);
                }
            }).catch(error => {
                console.error(`Failed to load char data for ${char}:`, error);
                const errorMessage = document.createElement('p');
                errorMessage.innerText = `Stroke order data not available for ${char}.`;
                container.appendChild(errorMessage);
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAndRenderCharacterStrokes(chineseCharacters);
    });
</script>
{% endblock %}
