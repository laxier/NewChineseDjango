<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lexical Exercises</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .child-exercise, .exercise-container {
            flex-direction: row;
            display: flex;
            justify-content: space-between;
        }

        .audio-player {
            margin-left: 10px;
            width: 80px;
        }

        .audio-container {
            font-size: 14px;
            width: 45%;
            margin: 20px 0;
        }

        .audio-content {
            border: 1px solid rgb(0, 0, 0); /* Single border around audio player and text */
            padding: 10px;
            border-radius: 0px;
        }

        .audio-text {
            font-size: 26px; /* Match chinese-dialogue */
            margin-top: 10px;
            text-align: left;
            font-family: KaiTi, 'Adobe Kaiti Std', SimSun, MingLiU, PMingLiU, Arial, sans-serif; /* Match chinese-dialogue */
        }

        .navigation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .chinese-dialogue {
            text-align: left;
            font-size: 26px;
            border-radius: 8px;
            margin: 20px 0;
            padding: 0;
            font-family: KaiTi, 'Adobe Kaiti Std', SimSun, MingLiU, PMingLiU, Arial, sans-serif;
        }
    </style>
</head>
<body>
<div id="lexical-exercises-container"></div>
<script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
    const {useState, useEffect, useRef} = React;

    const LexicalExercises = ({exercises}) => {
        const [currentIndex, setCurrentIndex] = useState(0);
        const mainAudioRef = useRef(null);
        const childAudioRefs = useRef([]);

        const handleNext = () => {
            if (currentIndex < exercises.length - 1) {
                setCurrentIndex(currentIndex + 1);
            }
        };

        const handlePrevious = () => {
            if (currentIndex > 0) {
                setCurrentIndex(currentIndex - 1);
            }
        };

        useEffect(() => {
            if (mainAudioRef.current) {
                mainAudioRef.current.pause();
                mainAudioRef.current.currentTime = 0;
                mainAudioRef.current.load();
            }
            childAudioRefs.current.forEach(ref => {
                if (ref) {
                    ref.pause();
                    ref.currentTime = 0;
                    ref.load();
                }
            });
        }, [currentIndex]);

        const currentExercise = exercises[currentIndex];

        const formatTextWithLineBreaks = (text) => {
            console.log('Input text:', text); // Debug: log raw input

            // Split text at double newline (\r\n\r\n or \n\n)
            const separator = /\r\n\r\n|\n\n/;
            const parts = text.split(separator);
            let mainTextLines = parts[0] ? parts[0].split(/\r?\n/) : [];
            let audioTextLines = parts[1] ? parts[1].split(/\r?\n/) : [];

            // Remove trailing empty lines from both parts
            mainTextLines = mainTextLines.filter(line => line.trim() !== '');
            audioTextLines = audioTextLines.filter(line => line.trim() !== '');

            console.log('Main text lines:', mainTextLines); // Debug
            console.log('Audio text lines:', audioTextLines); // Debug

            // Process lines for <b> and <u> tags
            const processLine = (line, lineIndex) => {
                const parts = [];
                let currentText = line;
                let partIndex = 0;

                // Regex to match <b> and <u> tags
                const regex = /(<b>.*?<\/b>|<u>.*?<\/u>)/g;
                const matches = line.match(regex) || [];
                let lastIndex = 0;

                line.replace(regex, (match, _, index) => {
                    if (index > lastIndex) {
                        parts.push(<span key={`${lineIndex}-${partIndex++}`}>{currentText.slice(lastIndex, index)}</span>);
                    }
                    if (match.startsWith('<b>')) {
                        const content = match.slice(3, -4);
                        parts.push(<strong key={`${lineIndex}-${partIndex++}`}>{content}</strong>);
                    } else if (match.startsWith('<u>')) {
                        const content = match.slice(3, -4);
                        parts.push(<u key={`${lineIndex}-${partIndex++}`}>{content}</u>);
                    }
                    lastIndex = index + match.length;
                });

                if (lastIndex < currentText.length) {
                    parts.push(<span key={`${lineIndex}-${partIndex++}`}>{currentText.slice(lastIndex)}</span>);
                }

                return (
                    <span key={lineIndex}>
                        {parts.length > 0 ? parts : line}
                        <br/>
                    </span>
                );
            };

            const mainText = mainTextLines.map((line, index) => processLine(line, index));
            const audioText = audioTextLines.map((line, index) => processLine(line, index + mainTextLines.length));

            console.log('Main text rendered:', mainText); // Debug
            console.log('Audio text rendered:', audioText); // Debug

            return { mainText, audioText };
        };

        return (
            <div className="lexical-exercises-container">
                <h2 className="title">Lexical Exercises</h2>

                <div className="navigation-controls">
                    <button className="btn btn-secondary" disabled={currentIndex === 0} onClick={handlePrevious}>← Previous</button>
                    <button className="btn btn-secondary" disabled={currentIndex === exercises.length - 1} onClick={handleNext}>Next →</button>
                </div>

                <div className="exercise-container">
                    <p className="chinese-dialogue">{formatTextWithLineBreaks(currentExercise.text).mainText}</p>
                    <div className="audio-container">
                        <div className="audio-content">
                            <audio className="audio-player" controls ref={mainAudioRef}>
                                <source src={currentExercise.audio_file} type="audio/mpeg"/>
                                Your browser does not support the audio element.
                            </audio>
                            {formatTextWithLineBreaks(currentExercise.text).audioText.length > 0 && (
                                <div className="audio-text">
                                    {formatTextWithLineBreaks(currentExercise.text).audioText}
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {currentExercise.children.length > 0 && (
                    <div className="child-exercises-container">
                        {currentExercise.children.map((child, index) => (
                            <div key={child.id} className="child-exercise">
                                <p className="chinese-dialogue">{formatTextWithLineBreaks(child.text).mainText}</p>
                                <div className="audio-container">
                                    <div className="audio-content">
                                        <audio className="audio-player" controls ref={el => childAudioRefs.current[index] = el}>
                                            <source src={child.audio_file} type="audio/mpeg"/>
                                            Your browser does not support the audio element.
                                        </audio>
                                        {formatTextWithLineBreaks(child.text).audioText.length > 0 && (
                                            <div className="audio-text">
                                                {formatTextWithLineBreaks(child.text).audioText}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // Parse the JSON data
    const exercisesData = {{lexical_exercises | safe}};

    // Render the React component
    ReactDOM.render(
        <LexicalExercises exercises={exercisesData}/>,
        document.getElementById('lexical-exercises-container')
    );
</script>
</body>
</html>